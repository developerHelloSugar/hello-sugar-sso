<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website 2 - SSO Login</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="card login-card">
            <h1>Sign In to Website 2</h1>
            <p class="subtitle">Use SSO to sign in from the main service</p>

            <div class="button-group">
                <button onclick="redirectToSSO()" class="btn btn-primary">
                    Sign in with SSO Service
                </button>
            </div>

            <div class="divider">
                <span>OR</span>
            </div>

            <div class="manual-sso">
                <p class="subtitle">Have an SSO token? Paste it here:</p>
                <input type="text" id="sso-token-input" placeholder="Paste SSO token" class="input-field">
                <button onclick="verifySSOToken()" class="btn btn-primary">Verify Token</button>
            </div>

            <div id="sso-status" class="sso-status"></div>
        </div>
    </div>

    <script>
        const SSO_SERVICE_URL = 'http://localhost:3002';
        const RETURN_URL = window.location.origin;

        function redirectToSSO() {
            console.log('[website2 sso-login] Redirecting to SSO with returnUrl:', RETURN_URL);
            window.location.href = `${SSO_SERVICE_URL}/login?returnUrl=${encodeURIComponent(RETURN_URL)}`;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const ssoToken = urlParams.get('token');
        const ssoStatusDiv = document.getElementById('sso-status');

        if (ssoToken) {
            document.getElementById('sso-token-input').value = ssoToken;
            verifySSOTokenValue(ssoToken);
        }

        async function verifySSOToken() {
            const token = document.getElementById('sso-token-input').value.trim();
            if (!token) {
                alert('Please enter an SSO token');
                return;
            }
            await verifySSOTokenValue(token);
        }

        async function verifySSOTokenValue(token) {
            ssoStatusDiv.innerHTML = '<div class="loading"></div> Verifying SSO token...';
            ssoStatusDiv.className = 'sso-status processing';

            try {
                const response = await fetch('/auth/sso/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    ssoStatusDiv.innerHTML = 'SSO login successful! Redirecting...';
                    ssoStatusDiv.className = 'sso-status success';

                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    ssoStatusDiv.innerHTML = `SSO login failed: ${data.error || 'Unknown error'}`;
                    ssoStatusDiv.className = 'sso-status error';
                }
            } catch (error) {
                console.error('Error verifying SSO token:', error);
                ssoStatusDiv.innerHTML = 'SSO verification failed. Please try again.';
                ssoStatusDiv.className = 'sso-status error';
            }
        }

        async function checkIfAlreadyLoggedIn() {
            try {
                const response = await fetch('/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.authenticated) {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }

        if (!ssoToken) {
            checkIfAlreadyLoggedIn();
        }
    </script>
</body>
</html>
